<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borderlands 4 Serial Mutation Engine (v4.4 - Intelligent Mutation)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #1a1a2e; color: #d4d4f4; display: flex; flex-direction: column; gap: 20px; }
        h1 { color: #ff9900; border-bottom: 2px solid #3e2060; padding-bottom: 10px; margin-bottom: 0; }
        h2 { color: #99ffff; margin-top: 15px; margin-bottom: 5px; }
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; margin: 0 auto; }
        .controls, .output { flex: 1; padding: 20px; background-color: #2c2a4a; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #4a4a7a; border-radius: 4px; background-color: #1a1a2e; color: #d4d4f4; font-family: monospace; font-size: 14px; }
        .repo-textarea { resize: none; height: 60px; overflow-y: auto; }
        textarea:not(.repo-textarea) { resize: vertical; min-height: 40px; }
        #output-yaml { min-height: 400px; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s, transform 0.1s; }
        #generate-btn { background-color: #ff9900; color: #1a1a2e; width: 100%; font-size: 1.1em; margin-top: 10px; }
        #generate-btn:hover:not(:disabled) { background-color: #ffb347; }
        #generate-btn:disabled { background-color: #555555; cursor: not-allowed; }
        #copy-btn { background-color: #4CAF50; color: white; margin-left: 10px; }
        #copy-btn:hover { background-color: #66BB6A; }
        #download-btn { background-color: #007bff; color: white; margin-left: 5px; }
        #download-btn:hover { background-color: #0056b3; }
        #reset-btn { background-color: #6c757d; color: white; width: 100%; margin-top: 8px; }
        #reset-btn:hover { background-color: #5a6268; }
        .status-bar { padding: 10px; background-color: #3e2060; border-radius: 4px; margin-bottom: 10px; font-weight: bold; }
        .progress-container { width: 100%; background-color: #4a4a7a; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 20px; background-color: #99ffff; width: 0%; text-align: center; line-height: 20px; color: #1a1a2e; font-weight: bold; transition: width 0.3s; }
        .hidden { display: none; }
        .tag-input-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .tag-input-group > div { padding: 10px; border-radius: 4px; background-color: #3e2060; }
        .repo-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    </style>
</head>
<body>

    <h1>Serial Mutation Engine</h1>
    
    <div class="container">
        <div class="controls">
            <div class="form-group"><label for="item-type">Item Mutation Target</label><select id="item-type"><option value="class_mod" selected>Class Mod</option><option value="shield">Shield</option><option value="ordnance">Ordnance</option><option value="enhancement">Enhancement</option><option value="gun">Gun</option><option value="repkit">Repkit</option></select></div>
            <h2>üì¶ God Roll Repositories</h2><p style="font-size: 0.9em; color: #99ffff;">Selected type below is used for mutations.</p><div class="repo-group"><div class="form-group"><label for="class_mod_repo">Class Mod Serials</label><textarea id="class_mod_repo" class="repo-textarea" placeholder="Paste complete Class Mod serials here..."></textarea></div><div class="form-group"><label for="shield_repo">Shield Serials</label><textarea id="shield_repo" class="repo-textarea" placeholder="Paste complete Shield serials here..."></textarea></div><div class="form-group"><label for="enhancement_repo">Enhancement Serials</label><textarea id="enhancement_repo" class="repo-textarea" placeholder="Paste complete Enhancement serials here..."></textarea></div><div class="form-group"><label for="gun_repo">Gun Serials</label><textarea id="gun_repo" class="repo-textarea" placeholder="Paste complete Gun serials here..."></textarea></div><div class="form-group"><label for="ordnance_repo">Ordnance Serials</label><textarea id="ordnance_repo" class="repo-textarea" placeholder="Paste complete Ordnance serials here..."></textarea></div><div class="form-group"><label for="repkit_repo">Repkit Serials</label><textarea id="repkit_repo" class="repo-textarea" placeholder="Paste complete Repkit serials here..."></textarea></div></div>
            <hr style="border-top: 1px solid #4a4a7a; margin: 20px 0;">
            <div class="form-group"><label for="seed">Base Serial Seed</label><textarea id="seed" rows="5" placeholder="Enter your base serial seed..."></textarea></div>
            
            <h2>Final Tail Length Offsets (Relative to Base Seed)</h2>
            <div class="tag-input-group">
                <div class="form-group"><label for="min-tail">Min Tail Offset</label><input type="number" id="min-tail" value="10"></div>
                <div class="form-group"><label for="max-tail">Max Tail Offset</label><input type="number" id="max-tail" value="50"></div>
                <div class="form-group"><label for="target-tail">Target Tail Offset</label><input type="number" id="target-tail" value="30"></div>
            </div>

            <h2>Serial Count by Tag Group</h2><p style="font-size: 0.9em; color: #d4d4f4;">TG4 uses "High-Value Part" mutation.</p><div class="tag-input-group"><div class="form-group"><label for="new-count">NEW (0)</label><input type="number" id="new-count" value="10000" min="0"></div><div class="form-group"><label for="tg1-count">TG1 (17)</label><input type="number" id="tg1-count" value="0" min="0"></div><div class="form-group"><label for="tg2-count">TG2 (33)</label><input type="number" id="tg2-count" value="0" min="0"></div><div class="form-group"><label for="tg3-count">TG3 (65)</label><input type="number" id="tg3-count" value="0" min="0"></div><div class="form-group"><label for="tg4-count">TG4 (129)</label><input type="number" id="tg4-count" value="0" min="0"></div></div>

            <hr style="border-top: 1px solid #4a4a7a; margin: 20px 0;">
            <h2>‚öôÔ∏è Advanced Tuning</h2>
            <div class="tag-input-group">
                <div class="form-group" style="background-color: #5a1835;">
                    <label for="protected-length">Protected Tail Length (Chars)</label>
                    <input type="number" id="protected-length" value="12" min="4" max="50">
                </div>
                <div class="form-group"><label for="part-size">High-Value Part Size</label><input type="number" id="part-size" value="5" min="3" max="10"></div>
                <div class="form-group"><label for="legendary-chance">TG3 "Stacking" Chance (%)</label><input type="number" id="legendary-chance" value="30" min="0" max="100"></div>
                <div class="form-group"><label for="crossover-chance">TG2/3 Crossover Chance (%)</label><input type="number" id="crossover-chance" value="75" min="0" max="100"></div>
                <div class="form-group" style="grid-column: 1 / 3;"><label for="progress-chunk-size">Progress Update Frequency</label><input type="number" id="progress-chunk-size" value="500" min="50"></div>
                <div class="form-group" style="grid-column: 1 / 3;"><label for="gpu-batch-size">GPU Random Number Batch Size</label><input type="number" id="gpu-batch-size" value="250000" min="50000"></div>
            </div>
            
            <div class="status-bar" id="status-message">Ready to generate.</div>
            <div class="progress-container hidden" id="progress-container">
                <div class="progress-bar" id="progress-bar"><span id="progress-percent">0%</span></div>
            </div>
            
            <button id="generate-btn" onclick="startGeneration()">GENERATE SERIALS</button>
            <button id="reset-btn" onclick="resetFormWithConfirm()">RESET FORM</button>

        </div>
        <div class="output">
            <h2>YAML Output <button id="copy-btn" onclick="copyToClipboard()"><span id="copy-text">Copy</span></button><button id="download-btn" onclick="downloadYAML()"><span id="download-text">Download</span></button></h2>
            <textarea id="output-yaml" readonly placeholder="Generated YAML will appear here..."></textarea>
        </div>
    </div>

<script>
    const worker = new Worker('generator.worker.js');

    worker.onmessage = function(e) {
        const { type, payload } = e.data;
        switch(type) {
            case 'progress': updateProgress(payload.processed, payload.total); break;
            case 'complete': finalizeGeneration(payload.yaml, payload.uniqueCount, payload.totalRequested); break;
            case 'warning': document.getElementById('status-message').textContent = `Warning: ${payload}`; break;
            case 'error': handleError(payload.message); break;
        }
    };

    function updateProgress(processed, total) {
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const percent = total > 0 ? Math.min(100, Math.floor((processed / total) * 100)) : 0;
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
        document.getElementById('status-message').textContent = `Generating... Processing ${processed.toLocaleString()} of ${total.toLocaleString()} serials.`;
    }

    function finalizeGeneration(yaml, uniqueCount, totalRequested) {
        document.getElementById('output-yaml').value = yaml;
        document.getElementById('status-message').textContent = `‚úÖ Generation Complete! Wrote ${uniqueCount.toLocaleString()} unique serials. (Requested: ${totalRequested.toLocaleString()}).`;
        document.getElementById('progress-container').classList.add('hidden');
        document.getElementById('generate-btn').disabled = false;
    }

    function handleError(message) {
        console.error("Worker Error:", message);
        document.getElementById('status-message').textContent = `‚ùå ERROR: ${message}`;
        document.getElementById('progress-container').classList.add('hidden');
        document.getElementById('generate-btn').disabled = false;
    }

    function startGeneration() {
        const btn = document.getElementById('generate-btn');
        btn.disabled = true;
        document.getElementById('output-yaml').value = "";
        document.getElementById('progress-container').classList.remove('hidden');
        
        const DEFAULT_SEED = "@Uge9B?m/)}}!ffxLNwtrrhUgJFvP19)9>F7c1drg69->2ZNDt8=I>e4x5g)=u;D`>fBRx?3?tmf{sYpdCQjv<(7NJN*DpHY(R3rc";
        const HEADER_RE = /^(@U[^!]*!)/;
        const seedValue = document.getElementById('seed').value || DEFAULT_SEED;
        const match = seedValue.match(HEADER_RE);
        const baseTailLength = match ? seedValue.substring(match[0].length).length : seedValue.substring(10).length;
        
        const minOffset = parseInt(document.getElementById('min-tail').value);
        const maxOffset = parseInt(document.getElementById('max-tail').value);
        const targetOffset = parseInt(document.getElementById('target-tail').value);

        const finalMinTail = Math.max(10, baseTailLength + minOffset);
        const finalMaxTail = Math.max(finalMinTail, baseTailLength + maxOffset);
        const finalTargetTail = Math.max(finalMinTail, baseTailLength + targetOffset);
        
        const config = {
            seed: seedValue,
            itemType: document.getElementById('item-type').value,
            minTail: finalMinTail,
            maxTail: finalMaxTail,
            targetTail: finalTargetTail,
            newCount: parseInt(document.getElementById('new-count').value),
            tg1Count: parseInt(document.getElementById('tg1-count').value),
            tg2Count: parseInt(document.getElementById('tg2-count').value),
            tg3Count: parseInt(document.getElementById('tg3-count').value),
            tg4Count: parseInt(document.getElementById('tg4-count').value),
            repositories: {
                class_mod: document.getElementById('class_mod_repo').value,
                shield: document.getElementById('shield_repo').value,
                enhancement: document.getElementById('enhancement_repo').value,
                gun: document.getElementById('gun_repo').value,
                ordnance: document.getElementById('ordnance_repo').value,
                repkit: document.getElementById('repkit_repo').value,
            },
            protectedLength: parseInt(document.getElementById('protected-length').value),
            partSize: parseInt(document.getElementById('part-size').value),
            legendaryChance: parseInt(document.getElementById('legendary-chance').value),
            crossoverChance: parseInt(document.getElementById('crossover-chance').value),
            progressChunkSize: parseInt(document.getElementById('progress-chunk-size').value),
            gpuBatchSize: parseInt(document.getElementById('gpu-batch-size').value)
        };
        
        const totalRequested = config.newCount + config.tg1Count + config.tg2Count + config.tg3Count + config.tg4Count;
        if (totalRequested === 0) {
            handleError("Request at least one serial.");
            return;
        }

        document.getElementById('status-message').textContent = `Sending job to background thread...`;
        updateProgress(0, totalRequested);
        worker.postMessage({ type: 'generate', payload: config });
    }
    
    async function copyToClipboard() {
        const textarea = document.getElementById('output-yaml');
        const copyText = document.getElementById('copy-text');
        const originalText = copyText.textContent;
        const yamlContent = textarea.value;
        if (!yamlContent) return alert("There is no YAML content to copy.");
        if (navigator.clipboard && window.isSecureContext) {
            try {
                await navigator.clipboard.writeText(yamlContent);
                copyText.textContent = "Copied!";
            } catch (err) {
                copyText.textContent = "Copy Failed";
                alert("Could not copy text. Your browser might have blocked the request.");
            } finally {
                setTimeout(() => { copyText.textContent = originalText; }, 2000);
            }
        } else {
            textarea.select();
            try { document.execCommand('copy'); copyText.textContent = "Copied!"; }
            catch (err) { copyText.textContent = "Error"; }
            finally { setTimeout(() => { copyText.textContent = originalText; }, 2000); }
        }
    }

    function downloadYAML() {
        const yamlContent = document.getElementById('output-yaml').value;
        const downloadText = document.getElementById('download-text');
        const originalText = downloadText.textContent;
        if (!yamlContent) return alert("There is no YAML content to download.");
        try {
            const blob = new Blob([yamlContent], { type: 'text/yaml;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "generated_serials.yaml");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            downloadText.textContent = "Downloaded!";
        } catch (err) {
            downloadText.textContent = "Error";
        } finally {
            setTimeout(() => { downloadText.textContent = originalText; }, 2000);
        }
    }

    function resetForm() {
        const DEFAULT_SEED = "@Uge9B?m/)}}!ffxLNwtrrhUgJFvP19)9>F7c1drg69->2ZNDt8=I>e4x5g)=u;D`>fBRx?3?tmf{sYpdCQjv<(7NJN*DpHY(R3rc";
        
        const repoIds = ['class_mod_repo', 'shield_repo', 'enhancement_repo', 'gun_repo', 'ordnance_repo', 'repkit_repo'];
        repoIds.forEach(id => document.getElementById(id).value = '');

        document.getElementById('item-type').value = 'class_mod';
        document.getElementById('seed').value = DEFAULT_SEED;
        
        document.getElementById('new-count').value = 10000;
        document.getElementById('tg1-count').value = 0;
        document.getElementById('tg2-count').value = 0;
        document.getElementById('tg3-count').value = 0;
        document.getElementById('tg4-count').value = 0;
        
        document.getElementById('min-tail').value = 10;
        document.getElementById('max-tail').value = 50;
        document.getElementById('target-tail').value = 30;
        
        document.getElementById('protected-length').value = 12;
        document.getElementById('part-size').value = 5;
        document.getElementById('legendary-chance').value = 30;
        document.getElementById('crossover-chance').value = 75;
        document.getElementById('progress-chunk-size').value = 500;
        document.getElementById('gpu-batch-size').value = 250000;

        document.getElementById('output-yaml').value = "";
        // THIS IS THE CORRECTED LINE WITH THE MISSING PARENTHESIS
        document.getElementById('status-message').textContent = "Form reset to defaults. Ready to generate 10,000 NEW items.";
        document.getElementById('progress-container').classList.add('hidden');
        document.getElementById('generate-btn').disabled = false;
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('progress-percent').textContent = '0%';
    }
    
    function resetFormWithConfirm() {
        if (confirm("Are you sure you want to reset all fields to their default values?")) {
            resetForm();
        }
    }

    window.onload = () => {
        if (document.getElementById('seed').value === '') {
            console.log("First visit detected. Setting form defaults.");
            resetForm();
        } else {
            console.log("Browser has restored form state. No changes made.");
            document.getElementById('status-message').textContent = "Restored previous settings. Ready to generate.";
        }
    };
</script>

</body>
</html>
