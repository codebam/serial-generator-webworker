<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borderlands 4 Serial Mutation Engine (v3.6 - Persistent State)</title>
    <style>
        /* CSS is identical, with an addition for the clear button */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #1a1a2e; color: #d4d4f4; display: flex; flex-direction: column; gap: 20px; }
        h1 { color: #ff9900; border-bottom: 2px solid #3e2060; padding-bottom: 10px; margin-bottom: 0; }
        h2 { color: #99ffff; margin-top: 15px; margin-bottom: 5px; }
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; margin: 0 auto; }
        .controls, .output { flex: 1; padding: 20px; background-color: #2c2a4a; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #4a4a7a; border-radius: 4px; background-color: #1a1a2e; color: #d4d4f4; font-family: monospace; font-size: 14px; }
        .repo-textarea { resize: none; height: 60px; overflow-y: auto; }
        textarea:not(.repo-textarea) { resize: vertical; min-height: 40px; }
        #output-yaml { min-height: 400px; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s, transform 0.1s; }
        #generate-btn { background-color: #ff9900; color: #1a1a2e; width: 100%; font-size: 1.1em; margin-top: 10px; }
        #generate-btn:hover:not(:disabled) { background-color: #ffb347; }
        #generate-btn:disabled { background-color: #555555; cursor: not-allowed; }
        #copy-btn { background-color: #4CAF50; color: white; margin-left: 10px; }
        #copy-btn:hover { background-color: #66BB6A; }
        #download-btn { background-color: #007bff; color: white; margin-left: 5px; }
        #download-btn:hover { background-color: #0056b3; }
        /* --- NEW STYLE FOR CLEAR BUTTON --- */
        #clear-btn { background-color: #dc3545; color: white; width: 100%; margin-top: 5px; }
        #clear-btn:hover { background-color: #c82333; }
        .status-bar { padding: 10px; background-color: #3e2060; border-radius: 4px; margin-bottom: 10px; font-weight: bold; }
        .progress-container { width: 100%; background-color: #4a4a7a; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 20px; background-color: #99ffff; width: 0%; text-align: center; line-height: 20px; color: #1a1a2e; font-weight: bold; transition: width 0.3s; }
        .hidden { display: none; }
        .tag-input-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .tag-input-group > div { padding: 10px; border-radius: 4px; background-color: #3e2060; }
        .repo-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    </style>
</head>
<body>

    <h1>Serial Mutation Engine</h1>
    
    <div class="container">
        <div class="controls">
            <!-- All previous form sections are unchanged -->
            <div class="form-group"><label for="item-type">Item Mutation Target</label><select id="item-type"><option value="class_mod" selected>Class Mod</option><option value="shield">Shield</option><option value="enhancement">Enhancement</option><option value="gun">Gun</option><option value="repkit">Repkit</option></select></div>
            <h2>üì¶ God Roll Repositories</h2><p style="font-size: 0.9em; color: #99ffff;">Selected type below is used for TG1-3 mutations.</p><div class="repo-group"><div class="form-group"><label for="class_mod_repo">Class Mod Serials</label><textarea id="class_mod_repo" class="repo-textarea" placeholder="Paste Class Mod serials here..."></textarea></div><div class="form-group"><label for="shield_repo">Shield Serials</label><textarea id="shield_repo" class="repo-textarea" placeholder="Paste Shield serials here..."></textarea></div><div class="form-group"><label for="enhancement_repo">Enhancement Serials</label><textarea id="enhancement_repo" class="repo-textarea" placeholder="Paste Enhancement serials here..."></textarea></div><div class="form-group"><label for="gun_repo">Gun Serials</label><textarea id="gun_repo" class="repo-textarea" placeholder="Paste Gun serials here..."></textarea></div><div class="form-group" style="grid-column: 1 / 3;"><label for="repkit_repo">Repkit Serials</label><textarea id="repkit_repo" class="repo-textarea" placeholder="Paste Repkit serials here..."></textarea></div></div>
            <hr style="border-top: 1px solid #4a4a7a; margin: 20px 0;">
            <div class="form-group"><label for="seed">Base Serial Seed</label><textarea id="seed" rows="5" placeholder="Enter your base serial seed..."></textarea></div>
            <h2>Mutation Tail Lengths</h2><div class="tag-input-group"><div class="form-group"><label for="min-tail">Min Tail</label><input type="number" id="min-tail" value="50"></div><div class="form-group"><label for="max-tail">Max Tail</label><input type="number" id="max-tail" value="400"></div><div class="form-group"><label for="target-tail">Target Tail</label><input type="number" id="target-tail" value="350"></div></div>
            <h2>Serial Count by Tag Group</h2><p style="font-size: 0.9em; color: #d4d4f4;">TG4 uses "High-Value Part" mutation.</p><div class="tag-input-group"><div class="form-group"><label for="new-count">NEW (0)</label><input type="number" id="new-count" value="10000" min="0"></div><div class="form-group"><label for="tg1-count">TG1 (17)</label><input type="number" id="tg1-count" value="0" min="0"></div><div class="form-group"><label for="tg2-count">TG2 (33)</label><input type="number" id="tg2-count" value="0" min="0"></div><div class="form-group"><label for="tg3-count">TG3 (65)</label><input type="number" id="tg3-count" value="0" min="0"></div><div class="form-group"><label for="tg4-count">TG4 (129)</label><input type="number" id="tg4-count" value="0" min="0"></div></div>
            <hr style="border-top: 1px solid #4a4a7a; margin: 20px 0;">
            <h2>‚öôÔ∏è Advanced Tuning</h2><p style="font-size: 0.9em; color: #d4d4f4;">Modify the algorithm. Settings are saved automatically.</p><div class="tag-input-group"><div class="form-group"><label for="part-size">High-Value Part Size</label><input type="number" id="part-size" value="5" min="3" max="10"></div><div class="form-group"><label for="legendary-chance">TG3 "Stacking" Chance (%)</label><input type="number" id="legendary-chance" value="30" min="0" max="100"></div><div class="form-group"><label for="crossover-chance">TG2/3 Crossover Chance (%)</label><input type="number" id="crossover-chance" value="75" min="0" max="100"></div><div class="form-group"><label for="progress-chunk-size">Progress Update Frequency</label><input type="number" id="progress-chunk-size" value="500" min="50"></div><div class="form-group" style="grid-column: 1 / 3;"><label for="gpu-batch-size">GPU Random Number Batch Size</label><input type="number" id="gpu-batch-size" value="250000" min="50000"></div></div>
            <!-- --- NEW CLEAR BUTTON --- -->
            <button id="clear-btn" onclick="clearState()">Clear Saved Settings & Reset to Defaults</button>
            
            <div class="status-bar" id="status-message">Ready to generate.</div>
            <div class="progress-container hidden" id="progress-container"><div class="progress-bar" id="progress-bar"><span id="progress-percent">0%</span></div></div>
            <button id="generate-btn" onclick="startGeneration()">GENERATE SERIALS</button>
        </div>
        <div class="output">
            <h2>YAML Output <button id="copy-btn" onclick="copyToClipboard()"><span id="copy-text">Copy</span></button><button id="download-btn" onclick="downloadYAML()"><span id="download-text">Download</span></button></h2>
            <textarea id="output-yaml" readonly placeholder="Generated YAML will appear here..."></textarea>
        </div>
    </div>

<script>
    const worker = new Worker('generator.worker.js');
    const LOCAL_STORAGE_KEY = 'serialGeneratorState_v1'; // Use a versioned key

    // List of all input IDs to be saved
    const allInputIds = [
        'item-type', 'class_mod_repo', 'shield_repo', 'enhancement_repo', 'gun_repo', 'repkit_repo',
        'seed', 'min-tail', 'max-tail', 'target-tail',
        'new-count', 'tg1-count', 'tg2-count', 'tg3-count', 'tg4-count',
        'part-size', 'legendary-chance', 'crossover-chance', 'progress-chunk-size', 'gpu-batch-size'
    ];

    // --- STATE PERSISTENCE FUNCTIONS ---
    function saveState() {
        try {
            const state = {};
            allInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    state[id] = element.value;
                }
            });
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
            console.log("State saved to localStorage.");
        } catch (error) {
            console.error("Failed to save state to localStorage:", error);
        }
    }

    function loadState() {
        try {
            const savedStateJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedStateJSON) {
                const savedState = JSON.parse(savedStateJSON);
                allInputIds.forEach(id => {
                    const element = document.getElementById(id);
                    // Check if the key exists in the saved object before setting
                    if (element && savedState[id] !== undefined) {
                        element.value = savedState[id];
                    }
                });
                document.getElementById('status-message').textContent = "Loaded saved settings.";
                console.log("State loaded from localStorage.");
            } else {
                // If no saved state, set defaults
                setDefaults();
            }
        } catch (error) {
            console.error("Failed to load state from localStorage:", error);
            setDefaults(); // Fallback to defaults if parsing fails
        }
    }

    function clearState() {
        if (confirm("Are you sure you want to clear all saved settings and reset the form to its original defaults?")) {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            location.reload(); // Easiest way to reset the form to its initial state
        }
    }

    function setDefaults() {
        const DEFAULT_SEED = "@Uge9B?m/)}}!ffxLNwtrrhUgJFvP19)9>F7c1drg69->2ZNDt8=I>e4x5g)=u;D`>fBRx?3?tmf{sYpdCQjv<(7NJN*DpHY(R3rc";
        document.getElementById('seed').value = DEFAULT_SEED;
        document.getElementById('shield_repo').value = "@Uge9B?m/)}}!ffxLNwtrrhUgJFvP19)9>F7c1drg69->2ZNDt8?a%6/#5j=uN@CY8kBRxci=#U<wLv)B8u_8Xiiue#N(nEBJ4(TB}M2FZBE8;`A2prKNc7%uE5j@gEbchb=Av#2d*byt@L%0YW(IIxE2a4YvP^2OisYpdCQjyvs6sbr>DpHY(RHPymsYpdCQjv;Oq_zk}DpHY(RHPymsYpdCQjv;Oq_zk}DpHY(RHPymsYpdCQjv;Oq_zk}DpHY(RHPymsYpdCQjv;Oq#_lmEkcosRHPymsYpdCQjv;Oq_zk}DpHY(RHPyS";
        document.getElementById('status-message').textContent = "Ready to generate. Large batches may take some time.";
    }

    // --- MAIN EXECUTION START ---
    function startGeneration() {
        const btn = document.getElementById('generate-btn');
        btn.disabled = true;
        document.getElementById('output-yaml').value = "";
        document.getElementById('progress-container').classList.remove('hidden');

        // The logic to gather config is now identical to saveState, just without the saving part.
        const config = {};
        allInputIds.forEach(id => {
            // Convert numerical inputs from string to number
            const element = document.getElementById(id);
            config[id.replace(/-/g, '_')] = element.type === 'number' ? parseInt(element.value, 10) : element.value;
        });
        
        // The config object sent to the worker needs the repository values nested
        config.repositories = {
            class_mod: config.class_mod_repo,
            shield: config.shield_repo,
            enhancement: config.enhancement_repo,
            gun: config.gun_repo,
            repkit: config.repkit_repo,
        };
        // Rename keys to match worker expectations
        config.newCount = config.new_count;
        config.tg1Count = config.tg1_count;
        config.tg2Count = config.tg2_count;
        config.tg3Count = config.tg3_count;
        config.tg4Count = config.tg4_count;

        const totalRequested = config.newCount + config.tg1Count + config.tg2Count + config.tg3Count + config.tg4Count;
        if (totalRequested === 0) {
            handleError("Request at least one serial.");
            return;
        }

        document.getElementById('status-message').textContent = `Sending job to background thread...`;
        updateProgress(0, totalRequested);
        
        worker.postMessage({ type: 'generate', payload: config });
    }

    // --- PAGE LOAD ---
    window.onload = () => {
        loadState(); // Load saved data OR set defaults

        // Attach event listeners to all inputs to save on change
        allInputIds.forEach(id => {
            const element = document.getElementById(id);
            if(element) {
                // Use 'input' for instant saving on textareas/numbers, 'change' for selects
                const eventType = element.tagName === 'SELECT' ? 'change' : 'input';
                element.addEventListener(eventType, saveState);
            }
        });
    };

    // --- UNCHANGED FUNCTIONS (Omitted for brevity) ---
    worker.onmessage=function(e){const{type:a,payload:t}=e.data;switch(a){case"progress":updateProgress(t.processed,t.total);break;case"complete":finalizeGeneration(t.yaml,t.uniqueCount,t.totalRequested);break;case"warning":document.getElementById("status-message").textContent=`Warning: ${t}`;break;case"error":handleError(t.message)}};function updateProgress(e,t){const a=document.getElementById("progress-bar"),n=document.getElementById("progress-percent"),o=0<t?Math.min(100,Math.floor(e/t*100)):0;a.style.width=`${o}%`,n.textContent=`${o}%`,document.getElementById("status-message").textContent=`Generating... Processing ${e.toLocaleString()} of ${t.toLocaleString()} serials.`}function finalizeGeneration(e,t,a){document.getElementById("output-yaml").value=e,document.getElementById("status-message").textContent=`‚úÖ Generation Complete! Wrote ${t.toLocaleString()} unique serials. (Requested: ${a.toLocaleString()}).`,document.getElementById("progress-container").classList.add("hidden"),document.getElementById("generate-btn").disabled=!1}function handleError(e){console.error("Worker Error:",e),document.getElementById("status-message").textContent=`‚ùå ERROR: ${e}`,document.getElementById("progress-container").classList.add("hidden"),document.getElementById("generate-btn").disabled=!1}async function copyToClipboard(){const e=document.getElementById("output-yaml"),t=document.getElementById("copy-text"),a=t.textContent,n=e.value;if(n){if(navigator.clipboard&&window.isSecureContext)try{await navigator.clipboard.writeText(n),t.textContent="Copied!"}catch(e){console.error("Asynchronous copy failed: ",e),t.textContent="Copy Failed",alert("Could not copy text.")}finally{setTimeout((()=>{t.textContent=a}),2e3)}else e.select(),setTimeout((()=>{t.textContent=a}),2e3)}}function downloadYAML(){const e=document.getElementById("output-yaml").value,t=document.getElementById("download-text"),a=t.textContent;if(!e)return void alert("There is no YAML content to download.");try{const n=new Blob([e],{type:"text/yaml;charset=utf-8;"}),o=URL.createObjectURL(n),d=document.createElement("a");d.setAttribute("href",o),d.setAttribute("download","generated_serials.yaml"),d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(o),t.textContent="Downloaded!"}catch(e){console.error("Could not initiate download: ",e),t.textContent="Error"}finally{setTimeout((()=>{t.textContent=a}),2e3)}};
</script>

</body>
</html>
